<!DOCTYPE html>
<html prefix="" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Integration of two python/django libraries">
<meta name="viewport" content="width=device-width">
<title>How to filter Polymorphic Models with Django Filters | Willy's blog</title>
<link href="../../assets/css/rst.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/code.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/theme.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="../../assets/css/screen.css">
<link rel="stylesheet" type="text/css" href="../../assets/css/nav.css">
<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic%7COpen+Sans:700,400%7CInconsolata">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://woile.github.io/posts/django-polymorphic-integration-with-django-filters/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><script src="https://use.fontawesome.com/ac3419ca62.js"></script><meta name="author" content="Woile">
<link rel="prev" href="../eurotrip-2016/" title="Eurotrip 2016" type="text/html">
<link rel="next" href="../guide-to-sublime-like-a-normal-person/" title="Guide to Sublime like a normal person" type="text/html">
<meta property="og:site_name" content="Willy's blog">
<meta property="og:title" content="How to filter Polymorphic Models with Django Filters">
<meta property="og:url" content="https://woile.github.io/posts/django-polymorphic-integration-with-django-filters/">
<meta property="og:description" content="Integration of two python/django libraries">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-03-02T20:58:22-03:00">
<meta property="article:tag" content="api">
<meta property="article:tag" content="django">
<meta property="article:tag" content="django-rest-framework">
<meta property="article:tag" content="drf">
<meta property="article:tag" content="filters">
<meta property="article:tag" content="polymorphic">
<meta property="article:tag" content="python">
</head>
<body class="nav-closed">

<div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
<li class="nav-opened" role="presentation">
                <a href="../../">Home</a>
            </li>
            <li class="nav-opened" role="presentation">
                <a href="../../stories/visited-places/">Around the world</a>
            </li>
            <li class="nav-opened" role="presentation">
                <a href="../../categories/">Tags</a>
            </li>
            <li class="nav-opened" role="presentation">
                <a href="../../rss.xml">RSS feed</a>
            </li>
            <li class="nav-opened" role="presentation">
                <a href="../../archive.html">Archive</a>
            </li>
            <li class="nav-opened" role="presentation">
                <a href="../../stories/who-am-i/">About me</a>
            </li>
    
    
    </ul>
</div>
<span class="nav-cover"></span>

<div class="site-wrapper">
    <header class="main-header post-head no-cover"><nav class="main-nav overlay clearfix"><a class="blog-logo" href="https://woile.github.io/"><img src="https://s.gravatar.com/avatar/7ff595c207c9b935811a691d2f3d2551?s=150" alt="Blog Logo"></a>
            <a class="menu-button" href="#"><span class="burger">☰</span><span class="word">Menu</span></a>
        </nav></header><main id="content" class="content" role="main"><article class="post post"><header class="post-header"><h1 class="post-title">How to filter Polymorphic Models with Django Filters</h1>
        <section class="post-meta"> by
            Woile
            on
                <a href="../../categories/api/">#api</a>,
                <a href="../../categories/django/">#django</a>,
                <a href="../../categories/django-rest-framework/">#django-rest-framework</a>,
                <a href="../../categories/drf/">#drf</a>,
                <a href="../../categories/filters/">#filters</a>,
                <a href="../../categories/polymorphic/">#polymorphic</a>,
                <a href="../../categories/python/">#python</a>,
            <time class="post-date" datetime="2017-03-02T20:58:22-03:00">
                2017-03-02 20:58
            </time></section></header><section class="post-content"><div>
<p>As the title says, I needed a way to filter my polymorphic models using my already defined
<code>rest_framework.FilterSet</code>, and as I didn't find much resources about it I'm sharing my experience here.</p>
<p>First, let's talk about <code>django-polymorphic</code> and <code>django-filters</code>, what are these libraries for.</p>
<!-- TEASER_END -->
<div class="section" id="django-polymorphic">
<h2>Django-polymorphic <a class="footnote-reference brackets" href="#id3" id="id1">1</a>
</h2>
<pre class="literal-block">Simplifies using inherited models in Django projects. When a query is made at the base
model, the inherited model classes are returned.</pre>
<p>One of the most important things to understand of polymorphic is, that when you ask for the queryset of the parent, every element is represented with its children classes. Let's see this.</p>
<p>I'll use the models examples provided by the <a class="reference external" href="https://django-polymorphic.readthedocs.io/en/stable/">docs</a>.</p>
<pre class="code python"><a name="rest_code_ba1f9b92da824166945bbae9e189d8ea-1"></a><span class="kn">from</span> <span class="nn">polymorphic.models</span> <span class="kn">import</span> <span class="n">PolymorphicModel</span>
<a name="rest_code_ba1f9b92da824166945bbae9e189d8ea-2"></a>
<a name="rest_code_ba1f9b92da824166945bbae9e189d8ea-3"></a><span class="k">class</span> <span class="nc">Project</span><span class="p">(</span><span class="n">PolymorphicModel</span><span class="p">):</span>
<a name="rest_code_ba1f9b92da824166945bbae9e189d8ea-4"></a>    <span class="n">topic</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<a name="rest_code_ba1f9b92da824166945bbae9e189d8ea-5"></a>    <span class="n">start_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<a name="rest_code_ba1f9b92da824166945bbae9e189d8ea-6"></a>    <span class="n">finish_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<a name="rest_code_ba1f9b92da824166945bbae9e189d8ea-7"></a>
<a name="rest_code_ba1f9b92da824166945bbae9e189d8ea-8"></a><span class="k">class</span> <span class="nc">ArtProject</span><span class="p">(</span><span class="n">Project</span><span class="p">):</span>
<a name="rest_code_ba1f9b92da824166945bbae9e189d8ea-9"></a>    <span class="n">artist</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<a name="rest_code_ba1f9b92da824166945bbae9e189d8ea-10"></a>
<a name="rest_code_ba1f9b92da824166945bbae9e189d8ea-11"></a><span class="k">class</span> <span class="nc">ResearchProject</span><span class="p">(</span><span class="n">Project</span><span class="p">):</span>
<a name="rest_code_ba1f9b92da824166945bbae9e189d8ea-12"></a>    <span class="n">supervisor</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</pre>
<pre class="code python"><a name="rest_code_b46883708bed40b0b3be3af89cc337da-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">Project</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="s2">"Department Party"</span><span class="p">)</span>
<a name="rest_code_b46883708bed40b0b3be3af89cc337da-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">ArtProject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="s2">"Painting with Tim"</span><span class="p">,</span> <span class="n">artist</span><span class="o">=</span><span class="s2">"T. Turner"</span><span class="p">)</span>
<a name="rest_code_b46883708bed40b0b3be3af89cc337da-3"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">ResearchProject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="s2">"Swallow Aerodynamics"</span><span class="p">,</span> <span class="n">supervisor</span><span class="o">=</span><span class="s2">"Dr. Winter"</span><span class="p">)</span>
</pre>
<pre class="code python"><a name="rest_code_67ebb96db1bd4fc0bcaff3154f0791b4-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">Project</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<a name="rest_code_67ebb96db1bd4fc0bcaff3154f0791b4-2"></a><span class="p">[</span> <span class="o">&lt;</span><span class="n">Project</span><span class="p">:</span>         <span class="nb">id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">topic</span> <span class="s2">"Department Party"</span><span class="o">&gt;</span><span class="p">,</span>
<a name="rest_code_67ebb96db1bd4fc0bcaff3154f0791b4-3"></a>  <span class="o">&lt;</span><span class="n">ArtProject</span><span class="p">:</span>      <span class="nb">id</span> <span class="mi">2</span><span class="p">,</span> <span class="n">topic</span> <span class="s2">"Painting with Tim"</span><span class="p">,</span> <span class="n">artist</span> <span class="s2">"T. Turner"</span><span class="o">&gt;</span><span class="p">,</span>
<a name="rest_code_67ebb96db1bd4fc0bcaff3154f0791b4-4"></a>  <span class="o">&lt;</span><span class="n">ResearchProject</span><span class="p">:</span> <span class="nb">id</span> <span class="mi">3</span><span class="p">,</span> <span class="n">topic</span> <span class="s2">"Swallow Aerodynamics"</span><span class="p">,</span> <span class="n">supervisor</span> <span class="s2">"Dr. Winter"</span><span class="o">&gt;</span> <span class="p">]</span>
</pre>
<p>As you can see, this can be really helpful when using Django Rest Framework (DRF) and model inheritance.
It allows to use just one model, in this case <code>Project</code>, in a <code>ModelViewSet</code> and you will receive all the instances for <code>Project</code>, <code>ArtProject</code> and <code>ResearchProject</code>. Take into account
that your serializer will have to handle the representation of each of the models.</p>
</div>
<div class="section" id="django-filter">
<h2>Django-filter <a class="footnote-reference brackets" href="#id4" id="id2">2</a>
</h2>
<pre class="literal-block">Is a generic, reusable application to alleviate writing some of the more mundane bits of view code. Specifically, it allows users to filter down a queryset based on a model’s fields.</pre>
<p>Fundamentally, when using django filters you'll want to create a class specifying the model's
fields by which a queryset can be filtered.</p>
<p>Let's modified a bit the example of the <a class="reference external" href="https://django-filter.readthedocs.io/en/latest/guide/usage.html">docs</a>:</p>
<pre class="code python"><a name="rest_code_d9a3b2a01e0545ab9e120ad4389a483f-1"></a><span class="kn">import</span> <span class="nn">django_filters</span>
<a name="rest_code_d9a3b2a01e0545ab9e120ad4389a483f-2"></a>
<a name="rest_code_d9a3b2a01e0545ab9e120ad4389a483f-3"></a><span class="k">class</span> <span class="nc">ProjectFilter</span><span class="p">(</span><span class="n">django_filters</span><span class="o">.</span><span class="n">FilterSet</span><span class="p">):</span>
<a name="rest_code_d9a3b2a01e0545ab9e120ad4389a483f-4"></a>    <span class="n">topic</span> <span class="o">=</span> <span class="n">django_filters</span><span class="o">.</span><span class="n">CharFilter</span><span class="p">(</span><span class="n">lookup_expr</span><span class="o">=</span><span class="s1">'iexact'</span><span class="p">)</span>
<a name="rest_code_d9a3b2a01e0545ab9e120ad4389a483f-5"></a>
<a name="rest_code_d9a3b2a01e0545ab9e120ad4389a483f-6"></a>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
<a name="rest_code_d9a3b2a01e0545ab9e120ad4389a483f-7"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">Project</span>
<a name="rest_code_d9a3b2a01e0545ab9e120ad4389a483f-8"></a>        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'start_date'</span><span class="p">,</span> <span class="s1">'finish_date'</span><span class="p">]</span>
</pre>
<p>And the view should look something like:</p>
<pre class="code python"><a name="rest_code_e443798880b74210a1048c19056b14af-1"></a><span class="k">def</span> <span class="nf">project_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<a name="rest_code_e443798880b74210a1048c19056b14af-2"></a>    <span class="n">f</span> <span class="o">=</span> <span class="n">ProjectFilter</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">Project</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<a name="rest_code_e443798880b74210a1048c19056b14af-3"></a>    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">'my_app/template.html'</span><span class="p">,</span> <span class="p">{</span><span class="s1">'filter'</span><span class="p">:</span> <span class="n">f</span><span class="p">})</span>
</pre>
<p>Obviously, this will help reduce the amount of code written, and will be way easier to mantain.
The good thing about this library, and what matters to me the most, is that it has a great <a class="reference external" href="https://django-filter.readthedocs.io/en/latest/guide/rest_framework.html">integration with DRF</a> by providing a DRF-specific FilterSet and a filter backend.</p>
</div>
<div class="section" id="filtering-by-a-polymorphic-model">
<h2>Filtering by a polymorphic model</h2>
<p>As we stated at the beginning what I wanted to do is filter by a <strong>polymorphic model</strong>, because we have different types of projects. This can be easily achieved by reading the docs, no seriously, by essentially using the <code>rest_framework.FilterSet</code> and using a customized filter with <a class="reference external" href="https://django-filter.readthedocs.io/en/latest/guide/usage.html#customize-filtering-with-filter-method">Filter.method</a> in our FilterSet.</p>
<pre class="code python"><a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-1"></a><span class="kn">import</span> <span class="nn">django_filters</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-2"></a>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-3"></a>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-4"></a><span class="k">def</span> <span class="nf">get_subclasses_as_choice</span><span class="p">(</span><span class="n">klass</span><span class="p">):</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-5"></a>    <span class="n">choices</span> <span class="o">=</span> <span class="p">{</span><span class="n">subclass</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">subclass</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-6"></a>               <span class="k">for</span> <span class="n">subclass</span> <span class="ow">in</span> <span class="n">klass</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()}</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-7"></a>    <span class="k">return</span> <span class="n">choices</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-8"></a>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-9"></a>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-10"></a><span class="k">class</span> <span class="nc">ProjectFilter</span><span class="p">(</span><span class="n">django_filters</span><span class="o">.</span><span class="n">rest_framework</span><span class="o">.</span><span class="n">FilterSet</span><span class="p">):</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-11"></a>    <span class="n">project_type</span> <span class="o">=</span> <span class="n">django_filters</span><span class="o">.</span><span class="n">MultipleChoiceFilter</span><span class="p">(</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-12"></a>        <span class="n">method</span><span class="o">=</span><span class="s1">'project_type_filter'</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">get_subclasses_as_choice</span><span class="p">(</span><span class="n">Project</span><span class="p">))</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-13"></a>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-14"></a>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-15"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">Project</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-16"></a>        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'topic'</span><span class="p">,</span> <span class="s1">'start_date'</span><span class="p">,</span> <span class="s1">'end_date'</span><span class="p">]</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-17"></a>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-18"></a>    <span class="k">def</span> <span class="nf">project_type_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-19"></a>        <span class="n">project_choices</span> <span class="o">=</span> <span class="n">get_subclasses_as_choice</span><span class="p">(</span><span class="n">Project</span><span class="p">)</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-20"></a>        <span class="n">selected_projects</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">project_choices</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-21"></a>                             <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
<a name="rest_code_2e4a236280fe44108d116d8afe6cbafe-22"></a>        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">instance_of</span><span class="p">(</span><span class="o">*</span><span class="n">selected_projects</span><span class="p">)</span>
</pre>
<p>Now, if our querystring includes a key <code>project_type</code>, it will check if the values match any of
the choices and it will return the queryset filtered by the specified choices.
And that's it, we have successfully filtered polymorphic models. Now we just need to add <code>ProjectFilter</code> to the <code>filter_class</code> in the <code>viewsets.ModelViewSet</code>.</p>
<p>Cheers!</p>
<dl class="footnote brackets">
<dt class="label" id="id3"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd>
<p><a class="reference external" href="https://github.com/django-polymorphic/django-polymorphic">https://github.com/django-polymorphic/django-polymorphic</a></p>
</dd>
<dt class="label" id="id4"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd>
<p><a class="reference external" href="https://github.com/carltongibson/django-filter">https://github.com/carltongibson/django-filter</a></p>
</dd>
</dl>
</div>
</div>
    </section><footer class="post-footer"><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="woile",
            disqus_url="https://woile.github.io/posts/django-polymorphic-integration-with-django-filters/",
        disqus_title="How to filter Polymorphic Models with Django Filters",
        disqus_identifier="cache/posts/django-polymorphic-integration-with-django-filters.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></footer></article><script>var disqus_shortname="woile";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script></main><footer class="site-footer clearfix"><section class="poweredby">Contents © 2020         <a href="mailto:santiwilly@gmail.com">Woile</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </section></footer>
</div>

    <script type="text/javascript" src="../../assets/js/jquery.js"></script><script type="text/javascript" src="../../assets/js/jquery.fitvids.js"></script><script type="text/javascript" src="../../assets/js/index.js"></script><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-77945905-1', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>
