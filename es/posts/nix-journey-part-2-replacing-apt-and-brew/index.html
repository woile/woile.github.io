<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="es">
<head>
<meta charset="utf-8">
<meta name="description" content="Moving away from brew and apt, to welcome nix and all it's benefits">
<meta name="viewport" content="width=device-width">
<title>Nix journey part 2: replacing apt and brew | Willy's blog</title>
<link href="../../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/index.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<style>
        .highlight pre, .code pre {
            white-space: pre;
        }
        </style>
<style>
        kbd {
            font-family: Consolas, "Lucida Console", monospace;
            display: inline-block;
            border-radius: 3px;
            padding: 0px 4px;
            box-shadow: 1px 1px 1px #777;
            margin: 2px;
            font-size: small;
            vertical-align: text-bottom;
            background: #eee;
            font-weight: 500;
            color: #555;
            cursor: pointer;
            font-variant: small-caps;
            font-weight: 600;

            /* This two work */
            /* letter-spacing: 0.5px; */
            letter-spacing: 1px;


            /* Prevent selection */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        </style>
<script type="text/javascript" src="https://latest.cactus.chat/cactus.js"></script><link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS (es)" hreflang="es" href="../../rss.xml">
<link rel="alternate" type="application/rss+xml" title="RSS (en)" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://woile.dev/es/posts/nix-journey-part-2-replacing-apt-and-brew/">
<!--[if lt IE 9]><script src="../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><script src="https://cdn.counter.dev/script.js" data-id="acc7e853-fadb-4b91-a2f2-801890951f1e" data-utcoffset="1"></script><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/nix.min.js"></script><script>hljs.highlightAll();</script><meta name="author" content="Woile">
<link rel="prev" href="../nix-journey-part-1-creating-a-flake/" title="Nix journey part 1: creating a flake" type="text/html">
<link rel="next" href="../nix-journey-part-3-learning-nix-lang/" title="Nix journey part 3: learning nix-lang" type="text/html">
<meta property="og:site_name" content="Willy's blog">
<meta property="og:title" content="Nix journey part 2: replacing apt and brew">
<meta property="og:url" content="https://woile.dev/es/posts/nix-journey-part-2-replacing-apt-and-brew/">
<meta property="og:description" content="Moving away from brew and apt, to welcome nix and all it's benefits">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2023-01-08T14:34:49Z">
<meta property="article:tag" content="apt">
<meta property="article:tag" content="brew">
<meta property="article:tag" content="flake">
<meta property="article:tag" content="nix">
<meta property="article:tag" content="package manager">
<meta property="article:tag" content="rust">
<link rel="alternate" hreflang="en" href="../../../posts/nix-journey-part-2-replacing-apt-and-brew/">
<link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
</head>
<body>
    <input id="dark-mode" type="checkbox"><div class="theme">
        
    <header class="cover"><input id="cool-menu" type="checkbox"><label for="cool-menu" class="cool-menu__label">
        <svg class="cool-menu hover:cool-menu checked:cool-menu" viewbox="0 0 100 100" width="40" height="40" aria-hidden="true"><circle cx="50" cy="50" r="50" fill-opacity="0.5"></circle></svg></label>
    <nav class="menu"><ul>
<li><a class="hover:menu__link" href="../../">üè† Inicio</a></li>
                <li><a class="hover:menu__link" href="../../../blog/">üì∞ Blog</a></li>
                <li><a class="hover:menu__link" href="../../mentoring/">üìó Mentoreo</a></li>
                <li><a class="hover:menu__link" href="../../archive.html">üóÑÔ∏è Archivo</a></li>
                <li><a class="hover:menu__link" href="../../categories/index.html">üè∑Ô∏è Tags</a></li>
                <li><a class="hover:menu__link" href="../../../rss.xml">üõ∞Ô∏è RSS feed</a></li>

        
        
        
        </ul>
<ul>
<li>
                        <span id="toptranslations">
                        <a href="../../../" class="hover:menu__link" rel="alternate" hreflang="en">English</a>

        </span>

            </li>
            <li>
                <label class="dark-mode-label hover:dark-mode-label" for="dark-mode">
                    <?xml version="1.0" encoding="UTF-8" standalone="no"?><!-- Generator: Gravit.io --><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="isolation: isolate;" viewbox="0 0 416 416" width="30px" height="30px"><defs><clippath id="_clipPath_qEPwrMg7OPn6mDBNPkG6Nqc7qffgU4IC"><rect width="416" height="416"></rect></clippath></defs><g clip-path="url(#_clipPath_qEPwrMg7OPn6mDBNPkG6Nqc7qffgU4IC)"><path d=" M 304 88 C 304 57.38 299.49 26.39 288 0 C 364.43 33.27 416 111.32 416 200 C 416 319.29 319.29 416 200 416 C 111.32 416 33.27 364.43 0 288 C 26.39 299.49 57.38 304 88 304 C 207.29 304 304 207.29 304 88 Z "></path></g></svg></label>
            </li>
        </ul></nav><h3 id="brand"><a href="../../" title="Willy's blog" rel="home">
            <span id="blog-title">Willy's blog</span>
        </a></h3>

    <div>

    </div>

    </header><div class="layout">
            <main id="content" class="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h2 class="p-name entry-title header__title" itemprop="headline name"><a href="." class="u-url hover:header__title__link">Nix journey part 2: replacing apt and brew</a></h2>

        <div class="metadata" style="margin-bottom: 3rem;">
            <span class="byline author vcard p-author h-card" style="display: flex;column-gap: 1rem; flex-wrap: wrap;">
                <span class="byline-name fn p-name" itemprop="author">
                        Woile
                </span>
                <span class="dateline">
                    <a class="article__meta__link hover:article__meta__link" href="." rel="bookmark">
                    <time class="published dt-published" datetime="2023-01-08T14:34:49Z" itemprop="datePublished" title="2023-01-08 14:34">2023-01-08 14:34</time></a>
                </span>
                        <span class="sourceline"><a class="article__meta__link hover:article__meta__link" href="index.md">C√≥digo fuente</a></span>

            </span>
            <br><span style="display: flex;column-gap: 1rem; flex-wrap: wrap;">
                <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/apt/" rel="tag">#apt</a>
                <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/brew/" rel="tag">#brew</a>
                <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/flake/" rel="tag">#flake</a>
                <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/nix/" rel="tag">#nix</a>
                <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/package-manager/" rel="tag">#package manager</a>
                <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/rust/" rel="tag">#rust</a>
            </span>

                <span class="commentline">

        </span>
</div>
        
    </header><section class="e-content entry-content" itemprop="articleBody text"><p>Even if I still cannot do much with <a href="https://nixos.org/">nix</a>, it still provides more advantages over other package managers:</p>
<ul>
<li>Multi-platform (mac, linux, etc.)</li>
<li>Supports side-by-side installation of multiple versions of a package</li>
<li>Makes it trivial to share development and build environments</li>
<li>Nix ensures that installing or upgrading one package cannot break other packages</li>
<li>It has the biggest database of packages (over 80.000 packages)</li>
<li>I can run other people's commands, for example if I clone a repo and it says "run this nix command to have a development environment", then it doesn't matter if I don't know, I have already started using it.</li>
</ul>
<p>A common situation I often run into, is writing shell scripts for linux and mac, where <code>grip</code> or <code>sed</code> are used.
On linux, they are called GNU <code>grep</code> or GNU <code>sed</code>, and they are not the same as in mac (freebsd version). Depending on the version, they may use different arguments.</p>
<p>We are going to see how can we avoid this by using <code>nix</code>. Even without using complicated features, it can make your CI system more reproducible.</p>
<p>Remember, <code>nix</code> is 3 things at the same time: an OS, a package manager and a language.</p>
<p>This post is about the <strong>package manager</strong>. I don't have much interest in the language, yet. Though more and more, I think I'll have to learn it.</p>
<p>Let's start by acknowledging a source of confusion:</p>
<p><strong>There is an old interface with counterintuitive commands</strong> (<code>nix-env -iA ...</code>, <code>nix-shell -p ...</code>), which I found hard to remember, and I don't get why the "commands" start with a dash (<code>-</code>). I'm used to cli's doing <code>cli &lt;command&gt; [--options]</code>. Nowadays, there's a new cli called just <code>nix</code>. Let's see if we can do everything with it.</p>
<p>And make sure you have <a href="https://nixos.org/download.html">installed Nix: the package manager</a> in your system. The installation is straightforward. I was personally blocked, because at some point in my dotfiles I was hardcoding the <code>PATH</code>, making nix never appear ü§¶‚Äç‚ôÇÔ∏è.</p>
<p>And <a href="https://nixos.wiki/wiki/Flakes#Enable_flakes">enable flakes</a>.</p>
<p>There's also a <a href="https://github.com/DeterminateSystems/nix-installer">new installer by determine systems</a>, which is quite good.</p>
<h3>Installing packages</h3>
<p>Install a package like on <code>brew</code> or <code>apt</code>.</p>
<pre class="highlight"><code class="language-sh">nix profile install nixpkgs#htop</code></pre>
<p>See also the <a href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-profile-install.html">profile install command reference</a>.</p>
<p>In the old version of nix, we would run:</p>
<pre class="highlight"><code class="language-sh">nix-env -iA nixpkgs.htop</code></pre>
<p>Nix forces us to specify a "repository" (or "namespace") when installing a package (<code>nixpkgs</code>), which could be different, like github. And I think this is a good thing. From my understanding, nix doesn't care where the package is, because each package has a lock file, tracking all the dependencies. Okay, it could be a problem if one of the "repositories" is down, but using <code>nixpkgs</code> mainly and github for niche packages should be fine.</p>
<h4>What are profiles?</h4>
<p>Disclaimer: I may be wrong on this, I'm starting to understand it.</p>
<p>The way to see <code>profiles</code> is like, "your user's packages". <code>nix profile</code> links packages to your <code>~/.nix-profile/</code>. You can specify other's profiles by using the flag <code>-p</code>.</p>
<p>You can find more in the <a href="https://nixos.org/manual/nix/stable/package-management/profiles.html">package-management section of the manual</a> and <a href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-profile.html">the profile command reference</a></p>
<h3>Searching packages</h3>
<pre class="highlight"><code class="language-sh">nix search nixpkgs#htop</code></pre>
<p>Check the <a href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-search.html">search command reference</a></p>
<p>We see again <code>nixpkgs</code>, because we have to let nix know from where, and then what we are looking for (<code>htop</code> in this case). To remember the word, I split it like this: <code>nix-p-k-gs</code>.</p>
<p>For example, I've made a flake package, hosted on github, and you can search what is offering, by specifying the "repository" only (no <code>#</code>):</p>
<pre class="highlight"><code class="language-sh">nix search 'github:woile/wpa_passphrase_rs'</code></pre>
<p>You can also search packages on <a href="https://search.nixos.org/packages?channel=22.11&amp;show=htop&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=htop">nix search index</a>, but the commands shown are for the old nix interface, using <code>nix-env</code> or <code>nix-shell</code>.</p>
<p>Also, you can provide a regex like <code>firefox|chrome</code>, run <code>nix search --help</code> for more examples.</p>
<h3>Removing packages</h3>
<p>Now this is a bit tricky, to remove you cannot type <code>htop</code>, you have to specify which dependency you want to clean. I think this is because you can have multiple versions of the same program. Also, one of your packages may depend on the version of another package, and if you also installed another version of the same package, and if you remove both, the original program that depends on one of them may break.</p>
<p>The solution to this is to list the installed packages in your profile, and then remove by position of said program.</p>
<pre class="highlight"><code class="language-sh">nix profile list</code></pre>
<pre class="highlight"><code class="language-sh">nix profile remove 4</code></pre>
<p>Check the <a href="https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-profile-remove.html">profile remove command reference</a>.</p>
<h3>Open a package on a shell</h3>
<p>This can be useful to test in isolation without installing a package in your profile.</p>
<pre class="highlight"><code class="language-sh">nix shell nixpkgs#htop nixpkgs#gnused nixpkgs#youtube-dl

sed --help
htop --help
youtube-dl --version
CTRL+D # exit</code></pre>
<h3>Nix Package Tool (npt)</h3>
<p>Because I'm not used to most of the seen commands, I built a thin abstraction on top of <code>nix</code> called <a href="https://github.com/woile/npt">npt</a>. Which aims to be a humble succesor to <code>apt</code>. It also requires less characters to use it.</p>
<p>The installation, as we've seen before, can be done by running:</p>
<pre class="highlight"><code class="language-sh">nix profile install 'github:woile/npt#npt'</code></pre>
<p>And then run <code>npt --help</code> and check the commands, I hope it helps the transition to nix.</p>
<p>Now you can install packages by doing:</p>
<pre class="highlight"><code class="language-sh">npt install htop github:woile/wpa_passphrase_rs#wpa_passphrase
# or npt i</code></pre>
<p>It's still a work in progress, but a good start. I want to add the ability to show the executed nix commands, as a way of learning nix.</p>
<h3>Reproducible scripts</h3>
<p>Remember when I said "even if you don't know much, someone else might", and having nix helps for this? and remember when I talked about my problems with <code>sed</code> and <code>grep</code>?</p>
<p>Turns out, nix can help in both of these situations, someone can write a reproducible shell script which you would execute, and even without knowing much, it would work.</p>
<p>A minor problem is that we cannot use flakes yet, meaning we cannot run <code>nix shell</code> and instead, we have to rely on <code>nix-shell</code>. But it's coming, see <a href="https://github.com/NixOS/nix/pull/5189">#5189</a>, <a href="https://github.com/NixOS/nix/issues/4715">#4715</a>.</p>
<p>In the meantime, let's try to solve the issue with what we have.</p>
<pre class="highlight"><code class="language-sh">touch gnu-example.sh
chmod +x gnu-example.sh
vim gnu-example.sh</code></pre>
<p>And paste the content of this script:</p>
<pre class="highlight"><code class="language-sh">#! /usr/bin/env nix-shell
#! nix-shell gnused gnugrep

grep -V
sed --version</code></pre>
<p>If run <code>./gnu-example.sh</code>, it would work both on linux, mac and probably also on freebsd.</p>
<p>Take a look at this other example, you can install a specific version of python and even dependencies.</p>
<pre class="highlight"><code class="language-python">#! /usr/bin/env nix-shell
#! nix-shell --pure -i python -p "python38.withPackages (ps: [ ps.django ])"

import django
print(django.__version__)</code></pre>
<p>This opens the door to replace <code>pyenv</code> and any <code>virtualenv</code> you will ever need.</p>
<p>Imagine creating a nix file specific to your project with its dependencies, which loads a shell with the dependencies when you navigate to the project folder automatically. Yes, you can say goodbye to any version manager (<code>pyenv</code>, <code>nvm</code>, etc).</p>
<p>You can read more about building a <code>shell.nix</code> in the <a href="https://nix.dev/tutorials/declarative-and-reproducible-developer-environments">nix.dev tutorial</a>. But keep in mind that <code>shell.nix</code> is being replaced by flakes.</p>
<h3>Flakes</h3>
<p>Flakes are becoming the universal way of doing things in nix. <a href="https://github.com/woile/wpa_passphrase_rs/blob/main/flake.nix#L19-L22">Creating shells</a>, build commands, <a href="https://github.com/woile/wpa_passphrase_rs/blob/main/flake.nix#L17">compiling your source code</a> or <a href="https://github.com/woile/rpi-iso-flake/blob/main/flake.nix#L22">creating ISO images</a>.</p>
<p>And there's a whole set of new tools making use of flakes that allow you to build dev shells, like <a href="https://github.com/cachix/devenv">devenv</a> or <a href="https://github.com/flox/flox">flox</a>.</p>
<p>An exciting future is ahead!</p>
<p>I hope you've learned something with this post, and if you liked it, please let me know in the comments section below or tag me on hachyderm <a href="https://hachyderm.io/@woile">@woile</a>.</p>
    </section><aside class="postpromonav"><nav><ul itemprop="keywords" class="tags article__meta">
<li>
            <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/apt/" rel="tag">#apt</a>
          </li>
          <li>
            <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/brew/" rel="tag">#brew</a>
          </li>
          <li>
            <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/flake/" rel="tag">#flake</a>
          </li>
          <li>
            <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/nix/" rel="tag">#nix</a>
          </li>
          <li>
            <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/package-manager/" rel="tag">#package manager</a>
          </li>
          <li>
            <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/rust/" rel="tag">#rust</a>
          </li>
        </ul>
<ul class="pager hidden-print pagination">
<li class="next">
                <a class="hover:pagination__link" href="../nix-journey-part-3-learning-nix-lang/" rel="next" title="Nix journey part 3: learning nix-lang">Siguiente publicaci√≥n</a>
            </li>
            <li class="previous">
                <a class="hover:pagination__link" href="../nix-journey-part-1-creating-a-flake/" rel="prev" title="Nix journey part 1: creating a flake">Publicaci√≥n anterior</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><script type="text/javascript" src="https://latest.cactus.chat/cactus.js"></script><div id="comment-section"></div>
<script>
initComments({
  node: document.getElementById("comment-section"),
  defaultHomeserverUrl: "https://matrix.cactus.chat:8448",
  serverName: "cactus.chat",
  siteName: "woile.dev",
  commentSectionId: "nix.journey.part.2.replacing.apt.and.brew"
})
</script></section></article></main>
</div>
    </div>
                <script src="../../../assets/js/index.js"></script><script src="../../../assets/js/mermaid.min.js"></script><script src="../../../assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
