<!DOCTYPE html>
<html prefix="
        og: http://ogp.me/ns# article: http://ogp.me/ns/article#
    " vocab="http://ogp.me/ns" lang="es">
<head>
<meta charset="utf-8">
<meta name="description" content="Makefiles are great, but sometimes they get a bit hard, this tutorial tries to reduce the complexity by teaching about it">
<meta name="viewport" content="width=device-width">
<title>Digesting Make and Makefiles | Willy's blog</title>
<link href="../../../assets/css/baguetteBox.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/rst_base.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/index.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/code.css" rel="stylesheet" type="text/css">
<style>
        .highlight pre, .code pre {
            white-space: pre;
        }
        </style>
<script type="text/javascript" src="https://latest.cactus.chat/cactus.js"></script><link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS (es)" hreflang="es" href="../../rss.xml">
<link rel="alternate" type="application/rss+xml" title="RSS (en)" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://woile.dev/es/posts/digesting-make-makefile/">
<!--[if lt IE 9]><script src="../../../assets/js/html5shiv-printshiv.min.js"></script><![endif]--><script>
    if(!sessionStorage.getItem("_swa")&&document.referrer.indexOf(location.protocol+"//"+location.host)!== 0){ fetch("https://counter.dev/track?"+new URLSearchParams({ referrer:document.referrer,screen:screen.width+"x"+screen.height,user:"Woile",utcoffset:"1"}), { referrerPolicy: "no-referrer-when-downgrade"})};sessionStorage.setItem("_swa","1");
</script><meta name="author" content="Woile">
<link rel="prev" href="../the-layout-team/" title="The Layout Team" type="text/html">
<link rel="next" href="../logging-in-python/" title="Logging in python" type="text/html">
<meta property="og:site_name" content="Willy's blog">
<meta property="og:title" content="Digesting Make and Makefiles">
<meta property="og:url" content="https://woile.dev/es/posts/digesting-make-makefile/">
<meta property="og:description" content="Makefiles are great, but sometimes they get a bit hard, this tutorial tries to reduce the complexity by teaching about it">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-02-17T12:21:47Z">
<meta property="article:tag" content="documentation">
<meta property="article:tag" content="gnu">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="make">
<meta property="article:tag" content="tutorial">
<meta property="article:tag" content="unix">
<link rel="alternate" hreflang="en" href="../../../posts/digesting-make-makefile/">
<link rel="stylesheet" href="https://latest.cactus.chat/style.css" type="text/css">
</head>
<body>
    <input id="dark-mode" type="checkbox"><div class="theme">
        
    <header class="cover"><input id="cool-menu" type="checkbox"><label for="cool-menu" class="cool-menu__label">
        <svg class="cool-menu hover:cool-menu checked:cool-menu" viewbox="0 0 100 100" width="40" height="40" aria-hidden="true"><circle cx="50" cy="50" r="50" fill-opacity="0.5"></circle></svg></label>
    <nav class="menu"><ul>
<li><a class="hover:menu__link" href="../../">üè† Inicio</a></li>
                <li><a class="hover:menu__link" href="../../../blog/">üì∞ Blog</a></li>
                <li><a class="hover:menu__link" href="../../mentoring/">üìó Mentoreo</a></li>
                <li><a class="hover:menu__link" href="../../archive.html">üóÑÔ∏è Archivo</a></li>
                <li><a class="hover:menu__link" href="../../categories/index.html">üè∑Ô∏è Tags</a></li>
                <li><a class="hover:menu__link" href="../../../rss.xml">üõ∞Ô∏è RSS feed</a></li>

        
        
        
        </ul>
<ul>
<li>
                        <span id="toptranslations">
                        <a href="../../../" class="hover:menu__link" rel="alternate" hreflang="en">English</a>

        </span>

            </li>
            <li>
                <label class="dark-mode-label hover:dark-mode-label" for="dark-mode">
                    <?xml version="1.0" encoding="UTF-8" standalone="no"?><!-- Generator: Gravit.io --><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="isolation: isolate;" viewbox="0 0 416 416" width="30px" height="30px"><defs><clippath id="_clipPath_qEPwrMg7OPn6mDBNPkG6Nqc7qffgU4IC"><rect width="416" height="416"></rect></clippath></defs><g clip-path="url(#_clipPath_qEPwrMg7OPn6mDBNPkG6Nqc7qffgU4IC)"><path d=" M 304 88 C 304 57.38 299.49 26.39 288 0 C 364.43 33.27 416 111.32 416 200 C 416 319.29 319.29 416 200 416 C 111.32 416 33.27 364.43 0 288 C 26.39 299.49 57.38 304 88 304 C 207.29 304 304 207.29 304 88 Z "></path></g></svg></label>
            </li>
        </ul></nav><h3 id="brand"><a href="../../" title="Willy's blog" rel="home">
            <span id="blog-title">Willy's blog</span>
        </a></h3>

    <div>

    </div>

    </header><div class="layout">
            <main id="content" class="content"><article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h2 class="p-name entry-title header__title" itemprop="headline name"><a href="." class="u-url hover:header__title__link">Digesting Make and Makefiles</a></h2>

        <div class="metadata" style="margin-bottom: 3rem;">
            <span class="byline author vcard p-author h-card" style="display: flex;column-gap: 1rem; flex-wrap: wrap;">
                <span class="byline-name fn p-name" itemprop="author">
                        Woile
                </span>
                <span class="dateline">
                    <a class="article__meta__link hover:article__meta__link" href="." rel="bookmark">
                    <time class="published dt-published" datetime="2022-02-17T12:21:47Z" itemprop="datePublished" title="2022-02-17 12:21">2022-02-17 12:21</time></a>
                </span>
                        <span class="sourceline"><a class="article__meta__link hover:article__meta__link" href="index.md">C√≥digo fuente</a></span>

            </span>
            <br><span style="display: flex;column-gap: 1rem; flex-wrap: wrap;">
                <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/documentation/" rel="tag">#documentation</a>
                <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/gnu/" rel="tag">#gnu</a>
                <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/linux/" rel="tag">#linux</a>
                <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/make/" rel="tag">#make</a>
                <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/tutorial/" rel="tag">#tutorial</a>
                <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/unix/" rel="tag">#unix</a>
            </span>

                <span class="commentline">

        </span>
</div>
        
    </header><section class="e-content entry-content" itemprop="articleBody text"><p>Make and its makefiles, are a fantastic tool to keep track of the commands needed to build or run an application.
I have recently done a big refactor for a project, where we make heavy use of Make, and decided to write this small piece about Make.</p>
<p>Just create a <code>Makefile</code> at the root of your project, start adding commands, and done... right? Not really.</p>
<p>Let's explore a bit more what I mean, and then try to build a mental model that matches reality a bit better,
closing with some magic you can do with Makefiles.</p>
<p>Set up a practice field by running in the terminal:</p>
<div class="code"><pre class="code literal-block">mkdir /tmp/practice
<span class="nb">cd</span> /tmp/practice
touch index.html
</pre></div>
<p>And write a minimal <code>Makefile</code> with your favourite editor (E.g: <code>vim Makefile</code>)</p>
<div class="code"><pre class="code literal-block"><span class="nf">build</span><span class="o">:</span>
    mkdir dist
    cp index.html dist/index.html
</pre></div>
<p>Then execute in your terminal:</p>
<div class="code"><pre class="code literal-block">make build
</pre></div>
<p>This will create a folder <code>dist</code>, and copy <code>index.html</code> into the folder <code>dist</code>.</p>
<p>This is good. Particularly for me, it documents the commands used by the project, and helps future me.</p>
<p>Let's refactor a bit, to show some extra functionality:</p>
<div class="code"><pre class="code literal-block"><span class="nf">dist</span><span class="o">:</span>
    mkdir dist

<span class="nf">build</span><span class="o">:</span> <span class="n">dist</span>
    cp index.html dist/index.html
</pre></div>
<p>Notice the <code>build: dist</code>, it means: call <code>dist</code> command <em>before</em> running <code>build</code></p>
<div class="code"><pre class="code literal-block">make build
</pre></div>
<p>The functionality remains the same.</p>
<h4>Recap</h4>
<blockquote>
<p>We created two commands: <code>build</code> and <code>dist</code>.</p>
<p>And <code>dist</code> is executed by the <code>build</code> before running itself.</p>
</blockquote>
<p>This is ok, but it's not necessary a correct mental model.
In the Makefile world, commands are not commands... but files.</p>
<h3>New mental model</h3>
<p>In a nutshell, make builds a <a href="https://en.wikipedia.org/wiki/Dependency_graph">dependency graph</a> of files and folders.</p>
<ul>
<li>
<code>build</code> and <code>dist</code> are actually <strong>target files</strong> (or folders).</li>
<li>doing <code>build: dist</code> means that <code>build</code> depends on <code>dist</code> existing first.</li>
</ul>
<p>If we had a file called <code>build</code> , doing <code>make build</code>, wouldn't execute anything.</p>
<div class="code"><pre class="code literal-block">touch build
make build
$ make: `build' is up to date.
</pre></div>
<p>If we want to actually treat <code>build</code> as a command, we have to add <code>.PHONY</code>.</p>
<div class="code"><pre class="code literal-block"><span class="nf">dist</span><span class="o">:</span>
    mkdir dist

<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">build</span>
<span class="nf">build</span><span class="o">:</span> <span class="n">dist</span>
    cp index.html dist/index.html
</pre></div>
<p>This way Make no longer sees <code>build</code> as a file, but instead as a recipe, and it will be
executed everytime.</p>
<h3>Back to targets</h3>
<p>Remember what we said about targets and dependency graph? No? Me neither.
Don't worry, I actually didn't say anything.</p>
<p>If you treat your targets as <strong>files</strong>, Make can keep track of the files that have
changed, and update only those.</p>
<p>By knowing this our previous example could be refactored into:</p>
<div class="code"><pre class="code literal-block"><span class="nf">dist</span><span class="o">:</span>
    mkdir dist

<span class="nf">dist/index.html</span><span class="o">:</span> <span class="n">dist</span>
    cp index.html dist/index.html
</pre></div>
<p>And now we tell Make to create our target file:</p>
<div class="code"><pre class="code literal-block">make dist/index.html
</pre></div>
<p>If we run multiple times, we get:</p>
<div class="code"><pre class="code literal-block">make: `dist/index.html' is up to date.
</pre></div>
<p>We would expect that by modifying <code>index.html</code>, and running <code>make dist/index.html</code>, it would be rebuilt,
but we are getting the same message.</p>
<h3>Dependencies</h3>
<p>We need to tell Make that it depends on another file: <code>index.html</code></p>
<div class="code"><pre class="code literal-block"><span class="nf">dist</span><span class="o">:</span>
    mkdir dist

<span class="nf">dist/index.html</span><span class="o">:</span> <span class="n">dist</span> <span class="n">index</span>.<span class="n">html</span>
    cp index.html dist/index.html
</pre></div>
<p>This time, if <code>index.html</code> is modified, <code>make dist/index.html</code> will run again.
Thus, when dependecies are updated, <strong>target files</strong> are recreated.</p>
<p><img alt="Makefile targets and dependencies" src="../../../images/makefile/make-targets-deps.png"></p>
<h3>Patterns</h3>
<p>Now let's say we have many html files</p>
<div class="code"><pre class="code literal-block">touch about.html privacy.html docs.html
</pre></div>
<p>And we want to do the same for all the files, without creating many commands in Make.
For this case we use a pattern (<code>%</code>), and some Make variables:</p>
<ul>
<li>
<code>$@</code>: the target file</li>
<li>
<code>$&lt;</code>: the input file</li>
</ul>
<div class="code"><pre class="code literal-block"><span class="nf">dist</span><span class="o">:</span>
    mkdir dist

<span class="nf">dist/%.html</span><span class="o">:</span> %.<span class="n">html</span> <span class="n">dist</span>
    cp $&lt; <span class="nv">$@</span>
</pre></div>
<div class="code"><pre class="code literal-block">make dist/about.html
</pre></div>
<p>And we would be explicitly telling Make which file to create.</p>
<p>But what if we want to copy all the files at the same time?</p>
<p>Our current implementation, doesn't know about the available files.
And we are providing the <code>about</code> to the <code>make dist/about.html</code>.</p>
<p>We have to find a way to "know" all the possible targets.</p>
<h3>Variables</h3>
<p>We are gonna find the source files (<code>*.html</code> files which are not in the <code>dist</code> folder), store in a variable,
and then use that information to create the target html files.</p>
<div class="code"><pre class="code literal-block"><span class="nv">SRC_HTMLS</span> <span class="o">:=</span> <span class="k">$(</span>shell find . -name <span class="s1">'*.html'</span> -depth <span class="m">1</span><span class="k">)</span>

<span class="nv">TARGET_HTMLS</span> <span class="o">:=</span> <span class="k">$(</span>SRC_HTMLS:./%.html<span class="o">=</span>dist/%.html<span class="k">)</span>

<span class="nf">.PHONY</span><span class="o">:</span> <span class="n">build</span>
<span class="nf">build</span><span class="o">:</span> <span class="k">$(</span><span class="nv">TARGET_HTMLS</span><span class="k">)</span>
    <span class="k">$(</span>info Done<span class="k">)</span>

<span class="nf">dist</span><span class="o">:</span>
    mkdir dist

<span class="nf">dist/%.html</span><span class="o">:</span> %.<span class="n">html</span> <span class="n">dist</span>
    cp $&lt; <span class="nv">$@</span>
</pre></div>
<div class="code"><pre class="code literal-block">make build
</pre></div>
<p>What happens is:</p>
<ul>
<li>
<code>build</code> has all the <code>TARGET_HTMLS</code> files as dependency</li>
<li>Make also sees <code>dist/%.html</code> and the pattern will fit the criteria for each <code>TARGET_HTMLS</code>
</li>
<li>In <code>dist/%.html</code> we have as dependency  the <code>%.html</code>, so Make takes the pattern and checks if a <code>%.html</code> file exist</li>
<li>If the conditions are met, it runs the <code>cp</code> command for each file, unless they are already present and not updated</li>
</ul>
<p>You can think of</p>
<div class="code"><pre class="code literal-block"><span class="nf">build</span><span class="o">:</span> <span class="k">$(</span><span class="nv">TARGET_HTMLS</span><span class="k">)</span>
</pre></div>
<p>As</p>
<div class="code"><pre class="code literal-block"><span class="nf">build</span><span class="o">:</span> <span class="n">dist</span>/<span class="n">index</span>.<span class="n">html</span> <span class="n">dist</span>/<span class="n">about</span>.<span class="n">html</span> <span class="n">dist</span>/<span class="n">docs</span>.<span class="n">html</span> <span class="n">dist</span>/<span class="n">privacy</span>.<span class="n">html</span>
</pre></div>
<p>Variables can be reference using <code>$()</code> or <code>${}</code>.</p>
<p>We also use <code>$(info Done)</code> to send information messages to the user.
Make also provides <code>$(warning text‚Ä¶)</code> for warnings, and
<code>$(error text...)</code> to exit earlier with an error code different than 0.
See <a href="https://www.gnu.org/software/make/manual/html_node/Make-Control-Functions.html">Make-Control-Functions</a></p>
<h3>One more time</h3>
<p>Let's start over by removing the <code>dist</code> folder, and see what happens</p>
<div class="code"><pre class="code literal-block">rm -rf dist
</pre></div>
<div class="code"><pre class="code literal-block">‚ùØ make build
mkdir dist
cp index.html dist/index.html
cp about.html dist/about.html
cp docs.html dist/docs.html
cp privacy.html dist/privacy.html
Done

‚ùØ make build
Done
make: Nothing to be done for `build'.
</pre></div>
<p>As you can see, files that have not changed, won't be rebuilt by Make.</p>
<p>Now, try using <code>touch</code> on the different <code>html</code> files and running <code>make build</code> to see what happens.</p>
<h3>More functionality</h3>
<p>Make is a powerful tool, and provides much more functionality, so far with the web stack
I haven't had the need for more complexity.</p>
<p>I usually wrap docker commands, and make use of different variables, but if the need arises,
make has extra functionality, life:</p>
<ul>
<li>functions</li>
<li>if/conditions</li>
<li>change the shell in which the commands are executed</li>
<li><code>.delete_on_error</code></li>
</ul>
<h3>Notes</h3>
<p>Make is usually a good way to keep track of a project's commands, as it's available in Unix systems,
and you can be up and running fast.
But by no means is perfect, it can sometimes be hard to read, or use.
It's not available on Windows. And because it was designed for the C,C++ era, it plays well with files,
but it doesn't mean it fits perfectly the web development paradigm, where you don't "transform" files much
and where <code>docker</code> is used a lot.</p>
<p>So depending on your situation, there are some popular alternatives:</p>
<ul>
<li>
<a href="https://github.com/casey/just">just</a>: modern approach to make written in rust</li>
<li>
<a href="https://earthly.dev/">earthly.dev</a>: repeatable builds based on docker</li>
<li>
<a href="https://bazel.build/">bazel</a>: build tool from Google</li>
<li>
<a href="https://github.com/github/scripts-to-rule-them-all">scripts-to-rule-them-all</a>: just use scripts, like <a href="https://github.com/encode/starlette/tree/master/scripts">starlette</a>
</li>
</ul>
<h3>Resources</h3>
<ul>
<li><a href="https://www.gnu.org/software/make/manual/html_node/">GNU Make Manual</a></li>
<li><a href="https://makefiletutorial.com/">Makefiletutorial</a></li>
</ul>
<blockquote>
<p>Thanks for reading! üëã</p>
<p>If you are interested in what I write, follow me on <a href="https://twitter.com/santiwilly">twitter</a>
</p>
</blockquote>
    </section><aside class="postpromonav"><nav><ul itemprop="keywords" class="tags article__meta">
<li>
            <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/documentation/" rel="tag">#documentation</a>
          </li>
          <li>
            <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/gnu/" rel="tag">#gnu</a>
          </li>
          <li>
            <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/linux/" rel="tag">#linux</a>
          </li>
          <li>
            <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/make/" rel="tag">#make</a>
          </li>
          <li>
            <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/tutorial/" rel="tag">#tutorial</a>
          </li>
          <li>
            <a class="tag p-category article__meta__link hover:article__meta__link" href="../../categories/unix/" rel="tag">#unix</a>
          </li>
        </ul>
<ul class="pager hidden-print pagination">
<li class="next">
                <a class="hover:pagination__link" href="../logging-in-python/" rel="next" title="Logging in python">Siguiente publicaci√≥n</a>
            </li>
            <li class="previous">
                <a class="hover:pagination__link" href="../the-layout-team/" rel="prev" title="The Layout Team">Publicaci√≥n anterior</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><script type="text/javascript" src="https://latest.cactus.chat/cactus.js"></script><div id="comment-section"></div>
<script>
initComments({
  node: document.getElementById("comment-section"),
  defaultHomeserverUrl: "https://matrix.cactus.chat:8448",
  serverName: "cactus.chat",
  siteName: "woile.dev",
  commentSectionId: "digesting-make-and-makefiles"
})
</script></section></article></main>
</div>
    </div>
                <script src="../../../assets/js/index.js"></script><script src="../../../assets/js/baguetteBox.min.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
